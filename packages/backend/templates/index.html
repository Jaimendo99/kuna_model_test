{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h1 class="text-center mb-4">Therapist Matching Model Comparison</h1>
        <p class="text-center text-muted mb-5">
            Help us compare different AI models by answering a few questions. 
            We'll show you matches from different models and you can tell us which works best!
        </p>

        <div class="card">
            <div class="card-body">
                <form id="questionnaireForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="form-text">We'll use this to save your responses and show you results.</div>
                    </div>

                    <hr>

                    {% for question in questions %}
                    <div class="mb-4">
                        <label class="form-label">{{ question.question_text }}</label>
                        {% if question.question_type == 'multiple_choice' %}
                            {% for option in question.options %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       name="question_{{ question.id }}" value="{{ option }}" 
                                       id="q{{ question.id }}_{{ loop.index }}">
                                <label class="form-check-label" for="q{{ question.id }}_{{ loop.index }}">
                                    {{ option }}
                                </label>
                            </div>
                            {% endfor %}
                        {% elif question.question_type == 'single_choice' %}
                            {% for option in question.options %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                       name="question_{{ question.id }}" value="{{ option }}" 
                                       id="q{{ question.id }}_{{ loop.index }}">
                                <label class="form-check-label" for="q{{ question.id }}_{{ loop.index }}">
                                    {{ option }}
                                </label>
                            </div>
                            {% endfor %}
                        {% elif question.question_type == 'scale' %}
                            <div class="d-flex justify-content-between align-items-center">
                                <span>1</span>
                                <input type="range" class="form-range" min="1" max="10" 
                                       name="question_{{ question.id }}" id="q{{ question.id }}"
                                       oninput="this.nextElementSibling.textContent = this.value">
                                <span>10</span>
                            </div>
                            <div class="text-center">
                                <span class="badge bg-primary">5</span>
                            </div>
                        {% elif question.question_type == 'text_input' %}
                            <textarea class="form-control" name="question_{{ question.id }}" 
                                      rows="3" placeholder="Your answer..."></textarea>
                        {% elif question.question_type == 'yes_no' %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                       name="question_{{ question.id }}" value="yes" 
                                       id="q{{ question.id }}_yes">
                                <label class="form-check-label" for="q{{ question.id }}_yes">Yes</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                       name="question_{{ question.id }}" value="no" 
                                       id="q{{ question.id }}_no">
                                <label class="form-check-label" for="q{{ question.id }}_no">No</label>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitButton">
                            Compare Models & Get Matches
                        </button>
                    </div>
                </form>

                <div id="loading" class="loading text-center mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Comparing models and finding your matches...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('questionnaireForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('submitButton').disabled = true;
    e.target.style.display = 'none';
    
    // Collect form data
    const formData = new FormData(e.target);
    const email = formData.get('email');
    const answers = [];
    
    // Get all questions from the page
    const questionElements = document.querySelectorAll('[name^="question_"]');
    const processedQuestions = new Set();
    
    questionElements.forEach(element => {
        const questionId = element.name.replace('question_', '');
        
        // Skip if we've already processed this question
        if (processedQuestions.has(questionId)) {
            return;
        }
        
        processedQuestions.add(questionId);
        
        // Handle different input types
        if (element.type === 'checkbox') {
            // For checkboxes, collect all checked values
            const checkedBoxes = document.querySelectorAll(`input[name="question_${questionId}"]:checked`);
            if (checkedBoxes.length > 0) {
                const values = Array.from(checkedBoxes).map(cb => cb.value);
                answers.push({question_id: questionId, answer: values});
            }
        } else if (element.type === 'radio') {
            // For radio buttons, get the selected value
            const selectedRadio = document.querySelector(`input[name="question_${questionId}"]:checked`);
            if (selectedRadio) {
                answers.push({question_id: questionId, answer: selectedRadio.value});
            }
        } else if (element.type === 'range') {
            // For range inputs
            answers.push({question_id: questionId, answer: parseInt(element.value)});
        } else if (element.tagName === 'TEXTAREA') {
            // For text areas
            if (element.value.trim()) {
                answers.push({question_id: questionId, answer: element.value.trim()});
            }
        }
    });
    
    console.log('Submitting data:', {email, answers});
    
    try {
        const response = await fetch('/api/compare-models', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                answers: answers
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            window.location.href = `/comparison/${result.comparison_id}`;
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Something went wrong'));
            document.getElementById('loading').style.display = 'none';
            document.getElementById('submitButton').disabled = false;
            e.target.style.display = 'block';
        }
    } catch (error) {
        console.error('Network error:', error);
        alert('Network error: ' + error.message);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('submitButton').disabled = false;
        e.target.style.display = 'block';
    }
});

// Update range slider display
document.querySelectorAll('input[type="range"]').forEach(slider => {
    slider.addEventListener('input', function() {
        this.nextElementSibling.nextElementSibling.firstElementChild.textContent = this.value;
    });
});
</script>
{% endblock %}
